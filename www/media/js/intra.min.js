(function(d,b,c){var a=true;d.isPublic=true;this.historyedited=false;this.hitoryCache=[];this.test="123";this.DEBUG=true;this.options={htmlContenant:"#contenant",sideBarContenant:"#sidebar"};loader=b("<div>",{"class":"loader"});d.log=function(e){if(e&&DEBUG){console.log(e)}return d};d.setOptions=function(e){options=b.extend(options,e)};d.init={all:function(){d.init.loader();d.init.history();d.init.loadCache();d.init.loadHtml();d.init.tooltip()},history:function(){if(window.history&&history.pushState){b(window).bind("popstate",function(f){if(historyedited){d.load.html(location.pathname+location.search);d.active(hitoryCache[location.pathname])}})}},loadCache:function(){b(document).on("click",'a[data-load="cache"]',function(f){historyedited=true;hitoryCache[location.pathname]=b(this).parent().siblings().children(".active");d.load.cache(b(this));d.active(this);f.preventDefault()})},loadHtml:function(){b(document).on("click",'a[data-load="html"]',function(g){var f=b(this).attr("href");historyedited=true;hitoryCache[location.pathname]=b(this).parent().siblings().children(".active");d.load.html(f);d.active(this);g.preventDefault()})},tooltip:function(){b("body").popover({selector:"[data-toggle=tooltip]",trigger:"hover",placement:"auto",title:function(){parts=b(this).attr("content").split("::",2);return parts.length==1?b(this).attr("title"):parts[0]},content:function(){parts=b(this).attr("content").split("::",2)[1];return parts?parts:b(this).attr("content")},container:"body"})},loader:function(){b(document).ready(function(){b("body").addClass("loaded")})}};d.active=function(e){if(!e.jQuery){e=b(e)}e.parent().siblings().children(".active").removeClass("active");e.addClass("active");return true};d.load={json:function(e,f){base={format:"json"};f=b.extend(base,f);return b.ajax({url:e,data:f,dataType:"json",error:function(){d.notification("Error loading data!","error","Error",5000)}})},html:function(e,h,f,g){base={format:"raw"};h=b.extend(base,h);f=typeof f!=="undefined"?f:options.htmlContenant;contenant=b(f);return b.ajax({url:e,data:h,beforeSend:function(){contenant.css({opacity:"0.6"});loader.appendTo(contenant)},success:function(i){html=b(i).find(f).children();contenant.fadeOut("fast",function(){contenant.empty().append(html).fadeIn();history.pushState(null,null,e);contenant.css({opacity:"1"});d.log("Load, HTML: "+e)})},error:function(){contenant.css({opacity:"1"});loader.remove();d.notification("Error loading data!","error","Error",5000)}})},script:function(f,g){b("script").each(function(){return load=(f!=b(this).attr("src"))});if(load){var e=document.createElement("script");if(typeof g!=="undefined"){if(e.readyState){e.onreadystatechange=function(){if(e.readyState=="loaded"||e.readyState=="complete"){e.onreadystatechange=null;g()}}}else{e.onload=function(){g()}}}e.src=f;document.getElementsByTagName("head")[0].appendChild(e);d.log("Load, Script:"+f);return true}return false},stylesheet:function(e){b("link").each(function(){return load=(e!=b(this).attr("href"))});if(load){b("head").append('<link rel="stylesheet" type="text/css" href="'+e+'" />');d.log("Load, Stylesheet:"+e);return true}return false},cache:function(e){if(b.type(e)==="object"){url=e.attr("href");type=typeof e.data("type")!=="undefined"?e.data("type"):"raw"}else{url=e;type="raw"}contenant=b(".main > div");currentUrl=window.location.pathname+window.location.search;currentName=document.location.pathname.match(/[^\/]+$/)[0].split(".")[0];callUrl=url;callName=callUrl.match(/[^\/]+$/)[0].split(".")[0];contenant.css({opacity:"0.3"});loader.appendTo(".main");if(type=="stored"){if(!Intra.cache.isCached("page_"+callName)){load=Intra.load.json(url,{format:"raw"});load.done(function(f){Intra.cache.store("page_"+callName,f);Intra.cache.store("page_"+callName,{md5:f.md5},"session");history.pushState(null,null,url);contenant.empty().hide().css({opacity:"1"}).html(b.parseHTML(f.html)).fadeToggle("fast");console.log("loadPage, Load, Stored, No cache: "+callName)}).fail(function(f){contenant.css({opacity:"1"});Intra.notification("Error loading the page!","error",null,10000)}).always(function(){loader.remove()})}else{data=Intra.cache.load("page_"+callName);session=Intra.cache.load("page_"+callName,"session");if(!session.md5){load=Intra.load.json(url,{format:"raw",md5:data.md5});load.done(function(f){if(f.html){data.html=f.html;data.md5=f.md5}Intra.cache.store("page_"+callName,data);Intra.cache.store("page_"+callName,{md5:data.md5},"session")});contenant.fadeOut("fast",function(){history.pushState(null,null,url);contenant.empty().hide().css({opacity:"1"}).html(b.parseHTML(data.html)).fadeToggle("fast");loader.remove();console.log("loadPage, Load, Stored, NoMD5: "+callName)})}else{contenant.fadeOut("fast",function(){history.pushState(null,null,url);contenant.empty().hide().css({opacity:"1"}).html(b.parseHTML(data.html)).fadeToggle("fast");loader.remove();console.log("loadPage, Load, Stored, MD5: "+callName)})}}}else{if(type=="raw"){load=Intra.load.json(url,{format:"raw"});load.done(function(f){if(f.timeout!=1){contenant.empty().hide().css({opacity:"1"}).html(f.html).fadeToggle("fast");history.pushState(null,null,url);IWars.refreshRessources(f.ressources);console.log("loadPage, Load, Raw: "+callName);if(!Intra.load.script("templates/system/"+callName+".js")){IWars.page[callName].init()}}else{window.location.href="./login.php"}}).fail(function(f){contenant.css({opacity:"1"});Intra.notification("Error loading the page!","error",null,10000)}).always(function(){loader.remove()})}}return false}};d.notification=function(f,g,i,e){var h={type:"info",delay:2000,position:"top center",autoHide:true,clickToHide:true};if(!b.isPlainObject(f)){f={text:f,title:i,type:g,delay:e}}f=b.extend(h,f);if(f.type=="error"){icon="icon-alert"}else{if(f.type=="warning"){icon="icon-attention"}else{if(f.type=="success"){icon=" icon-ok-circle"}else{if(f.type=="info"){icon="icon-lamp-1"}else{icon="icon-info-1"}}}}b.notify({title:f.title,text:f.text,image:'<i class="'+icon+'"></i>'},{style:"metro",className:f.type,globalPosition:f.position,showAnimation:"show",showDuration:0,hideDuration:0,autoHideDelay:f.delay,autoHide:f.autoHide,clickToHide:f.clickToHide});return d};d.cache={localStoreSupport:function(){try{return"localStorage" in window&&window.localStorage!==null}catch(f){d.log("localStorage not avalaible!");return false}},store:function(e,h,f){if(this.localStoreSupport()){f=f=="session"?sessionStorage:localStorage;var g=JSON.stringify(h);f[e]=g;d.log("Cache, Store: "+e);return true}return false},load:function(e,f){if(this.localStoreSupport()){f=f=="session"?sessionStorage:localStorage;d.log("Cache, Load: "+e);if(f[e]){return jQuery.parseJSON(f[e])}return null}return false},isCached:function(e,f){if(this.localStoreSupport()){f=f=="session"?sessionStorage:localStorage;console.log("Cache, isCached: "+e);return(f[e]?true:false)}return false}}}(window.Intra=window.Intra||{},jQuery));